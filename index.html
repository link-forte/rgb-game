<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ </title>
    <!-- PWAé–¢é€£ã®ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="theme-color" content="#4CAF50">
    <meta property="og:title" content="RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ ">
    <meta property="og:description" content="é›ãˆã‚çµ¶å¯¾RGBåŠ›">
    <meta property="og:image" content="https://link-forte.github.io/rgb-game/rgb-game.png">
    <meta property="og:url" content="https://link-forte.github.io/rgb-game/">
    <meta property="og:type" content="website">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: #333;
            transition: color 0.3s;
        }

        #rgb-display {
            font-size: 24px;
            margin: 20px 0;
            color: #333;
            font-weight: bold;
            transition: color 0.3s, background-color 0.3s;
        }

        #color-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
        }

        .color-square {
            aspect-ratio: 1/1;
            width: 100%;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative; /* ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ç›¸å¯¾ä½ç½®è¨­å®š */
            overflow: hidden; /* ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
        }

        /* è‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .color-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ãƒ«ãƒ¼ã•ã›ã‚‹ */
        }

        /* å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pattern-lines {
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.5) 10px, rgba(255, 255, 255, 0.5) 20px);
        }

        .pattern-dots {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.5) 3px, transparent 3px);
            background-size: 20px 20px;
        }

        .pattern-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.5) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.5) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* æ•°å­—ãƒ©ãƒ™ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .color-number {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ãƒ«ãƒ¼ã•ã›ã‚‹ */
        }

        .color-square:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* New style for clicked squares */
        .clicked {
            pointer-events: none;
            opacity: 0.5;
        }

        #message {
            margin: 20px 0;
            font-size: 20px;
            font-weight: bold;
            min-height: 30px;
            transition: color 0.3s;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        /* é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .difficulty-btn {
            background-color: #72c477;  /* æ˜ã‚‹ã‚ã®ç·‘ */
        }

        .difficulty-btn:hover {
            background-color: #61b366;  /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—æš—ã‚ã« */
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .difficulty-btn.active {
            background-color: #4CAF50;  /* å…ƒã®ç·‘è‰² */
            cursor: default;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);  /* ç·‘ã®å…‰å½© */
            transform: scale(1.05);
            font-weight: bold;  /* é¸æŠä¸­ã®ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤ªå­—ã« */
        }

        .difficulty-btn.active:hover {
            background-color: #4CAF50;  /* ãƒ›ãƒãƒ¼æ™‚ã‚‚è‰²ã‚’ç¶­æŒ */
        }

        /* è‰²è¦šãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .colorblind-btn {
            background-color: #9575cd;  /* ç´«ç³» */
        }

        .colorblind-btn:hover {
            background-color: #7e57c2;  /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—æš—ã‚ã« */
        }

        .colorblind-btn.active {
            background-color: #673ab7;  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®è‰² */
            cursor: default;
            box-shadow: 0 0 10px rgba(103, 58, 183, 0.5);  /* ç´«ã®å…‰å½© */
            transform: scale(1.05);
            font-weight: bold;
        }

        .colorblind-btn.active:hover {
            background-color: #673ab7;  /* ãƒ›ãƒãƒ¼æ™‚ã‚‚è‰²ã‚’ç¶­æŒ */
        }

        /* ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-mode-btn {
            background-color: #ff9800;  /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
        }

        .game-mode-btn:hover {
            background-color: #e68a00;  /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—æš—ã‚ã« */
        }

        .game-mode-btn.active {
            background-color: #f57c00;  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®è‰² */
            cursor: default;
            box-shadow: 0 0 10px rgba(245, 124, 0, 0.5);  /* ã‚ªãƒ¬ãƒ³ã‚¸ã®å…‰å½© */
            transform: scale(1.05);
            font-weight: bold;
        }

        .game-mode-btn.active:hover {
            background-color: #f57c00;  /* ãƒ›ãƒãƒ¼æ™‚ã‚‚è‰²ã‚’ç¶­æŒ */
        }

        /* æ–°ã—ã„é›£æ˜“åº¦è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .difficulty-row, .colorblind-row, .game-mode-row, .settings-row {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #share-score {
            background-color: #1D9BF0;
            display: none;
        }

        #share-score:hover {
            background-color: #0d8bd9;
        }

        #show-correct {
            background-color: #ff9800;
            display: none;
        }

        #show-correct:hover {
            background-color: #e68a00;
        }

        #retry-problem {
            background-color: #2196F3;
            display: none;
        }

        #retry-problem:hover {
            background-color: #0b7dda;
        }

        #score {
            font-size: 18px;
            margin: 10px 0;
            transition: color 0.3s;
        }

        #combo {
            font-size: 16px;
            margin: 5px 0;
            color: #9c27b0;
            font-weight: bold;
            transition: color 0.3s;
        }

        /* é›£æ˜“åº¦èª¬æ˜ */
        .settings-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0 15px 0;
            transition: color 0.3s;
        }

        /* ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .time-bonus-btn {
            background-color: #7986cb;
            padding: 8px 16px;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        .time-bonus-btn.active {
            background-color: #3f51b5;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(63, 81, 181, 0.5);
        }

        .time-bonus-btn:hover {
            background-color: #5c6bc0;
        }

        /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .theme-btn {
            background-color: #555;
            color: white;
        }

        .theme-btn:hover {
            background-color: #444;
        }

        .theme-btn.light-mode {
            background-color: #f8d568;
            color: #333;
        }

        .theme-btn.light-mode:hover {
            background-color: #e5c455;
        }

        #time-info {
            font-size: 16px;
            color: #3f51b5;
            margin: 5px 0;
            font-weight: bold;
        }

        /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-over {
            color: red;
            font-size: 28px;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        /* æ­£è§£ã®è‰²ã‚’ç¤ºã™ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« - æ­£è§£ç¢ºèªãƒœã‚¿ãƒ³ç”¨ */
        .correct-color {
            border: 4px solid gold;
            animation: pulse 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body.dark-theme {
            background-color: #222;
            color: #eee;
        }

        body.dark-theme h1 {
            color: #fff;
        }

        body.dark-theme #rgb-display {
            color: #fff;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }

        body.dark-theme .color-square {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        body.dark-theme .color-square:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        body.dark-theme #message {
            color: #ddd;
        }

        body.dark-theme .settings-info {
            color: #aaa;
        }

        body.dark-theme #score,
        body.dark-theme #combo {
            color: #ddd;
        }

        /* New button container styles */
        .button-container {
            margin: 10px 0;
        }

        /* è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #settings-button {
            background-color: #607d8b;
        }

        #settings-button:hover {
            background-color: #455a64;
        }

        /* è¨­å®šãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .settings-button-container {
            margin-top: 10px;
            margin-bottom: 20px;
        }

        /* ç„¡é™ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        #infinite-streak {
            font-size: 16px;
            margin: 5px 0;
            color: #ff9800;
            font-weight: bold;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¹ã‚¿ã‚¤ãƒ« - æ–°è¦è¿½åŠ  */
        .modal {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* åŠé€æ˜ã®èƒŒæ™¯ */
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        body.dark-theme .modal-content {
            background-color: #333;
            color: #eee;
        }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover {
            color: #f44336;
        }

        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        body.dark-theme .settings-section {
            border-bottom: 1px solid #555;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            margin-top: 0;
            color: #4CAF50;
            text-align: left;
            margin-bottom: 15px;
        }

        body.dark-theme .settings-section h3 {
            color: #8bc34a;
        }

        /* PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #install-app {
            background-color: #3f51b5;
            display: none;
            margin-top: 15px;
        }

        #install-app:hover {
            background-color: #303f9f;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
        @media screen and (max-width: 768px) {
            #color-container {
                gap: 10px;
                padding: 5px;
            }

            button {
                padding: 12px 24px;
                margin: 8px 5px;
                font-size: 14px;
            }

            #rgb-display {
                font-size: 20px;
            }

            h1 {
                font-size: 24px;
            }

            p {
                font-size: 14px;
            }

            .modal-content {
                margin: 15% auto;
                width: 90%;
                padding: 15px;
            }
        }

        @media screen and (max-width: 480px) {
            #color-container {
                gap: 6px;
                padding: 3px;
            }

            .difficulty-btn, .colorblind-btn, .game-mode-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .modal-content {
                margin: 20% auto;
                width: 95%;
                padding: 10px;
            }

            #message {
                font-size: 16px;
            }
        }
    </style>

    <!-- OGPã‚¿ã‚° -->
    <meta property="og:title" content="RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ " />
    <meta property="og:description" content="RGBå€¤ã«åˆã†è‰²ã‚’å½“ã¦ã‚‹è„³ãƒˆãƒ¬ã‚²ãƒ¼ãƒ ï¼" />
    <meta property="og:image" content="./rgb-game-ogp.svg" />
    <meta property="og:url" content="https://github.com/hmmf022" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ " />
    <meta name="twitter:card" content="summary_large_image" />
</head>
<body>
    <h1>RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ </h1>
    <p>ä»¥ä¸‹ã®RGBå€¤ã«åˆã†è‰²ã‚’é¸ã‚“ã§ãã ã•ã„ï¼</p>
    <p id="game-rules">æ³¨æ„ï¼šé€£ç¶šã§é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆç°¡å˜ï¼š2å›ã€æ™®é€šãƒ»é›£ã—ã„ï¼š3å›ï¼‰</p>

    <div id="rgb-display">RGB(255, 255, 255)</div>

    <div id="color-container"></div>

    <div id="message"></div>

    <div id="score">ã‚¹ã‚³ã‚¢: 0</div>
    <div id="combo"></div>
    <div id="infinite-streak"></div>
    <div id="time-info"></div>

    <div class="button-container">
        <button id="new-game">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
        <button id="share-score">Blueskyã«å…±æœ‰</button>
        <button id="show-correct">æ­£è§£ã‚’ç¢ºèª</button>
        <button id="retry-problem">å•é¡Œã‚’ç¢ºèª</button>
    </div>

    <div class="settings-button-container">
        <button id="settings-button">è¨­å®š</button>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« - ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ã¨ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’è¿½åŠ  -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ã‚²ãƒ¼ãƒ è¨­å®š</h2>

            <!-- ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="settings-section">
                <h3>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="game-mode-row">
                    <button id="normal-mode-btn" class="game-mode-btn active" onclick="setGameMode('normal')">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
                    <button id="infinite-mode-btn" class="game-mode-btn" onclick="setGameMode('infinite')">ç„¡é™ãƒ¢ãƒ¼ãƒ‰</button>
                </div>

                <div class="settings-info">
                    é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šé€£ç¶šã§é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€æ­£è§£ã™ã‚‹ã¨æ¬¡ã®å•é¡Œã¸
                    <br>ç„¡é™ãƒ¢ãƒ¼ãƒ‰ï¼šä¸æ­£è§£ã®å ´åˆã¯æ­£è§£ã‚’è¡¨ç¤ºã—ã¦æ¬¡ã¸ã€æ­£è§£ã®å ´åˆã¯ãã®ã¾ã¾æ¬¡ã¸
                </div>
            </div>

            <!-- é›£æ˜“åº¦è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="settings-section">
                <h3>é›£æ˜“åº¦</h3>
                <!-- ç¬¬1è¡Œï¼šè‰²ã®å·®ã«åŸºã¥ãé›£æ˜“åº¦ -->
                <div class="difficulty-row">
                    <button id="easy-btn" class="difficulty-btn" onclick="setDifficulty('easy')">ç°¡å˜ (è‰²ã®å·®ãŒå¤§ãã„)</button>
                    <button id="medium-btn" class="difficulty-btn active" onclick="setDifficulty('medium')">æ™®é€š (é©åº¦ãªè‰²ã®å·®)</button>
                    <button id="hard-btn" class="difficulty-btn" onclick="setDifficulty('hard')">é›£ã—ã„ (è‰²ã®å·®ãŒå°ã•ã„)</button>
                </div>

                <!-- ç¬¬2è¡Œï¼šãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ï¼ˆè¡¨ç¤ºæ•°ãŒç•°ãªã‚‹ï¼‰ -->
                <div class="difficulty-row">
                    <button id="random3-btn" class="difficulty-btn" onclick="setDifficulty('random3')">ãƒ©ãƒ³ãƒ€ãƒ  (3è‰²)</button>
                    <button id="random6-btn" class="difficulty-btn" onclick="setDifficulty('random6')">ãƒ©ãƒ³ãƒ€ãƒ  (6è‰²)</button>
                    <button id="random9-btn" class="difficulty-btn" onclick="setDifficulty('random9')">ãƒ©ãƒ³ãƒ€ãƒ  (9è‰²)</button>
                </div>

                <div class="settings-info">
                    ç°¡å˜ï¼šè‰²ã®å·®ãŒå¤§ãã(CIEDE2000å€¤ 10ä»¥ä¸Š)ã€ã¯ã£ãã‚Šã¨åŒºåˆ¥ã§ãã‚‹è‰²
                    <br>æ™®é€šï¼šé©åº¦ãªè‰²ã®å·®ã§ã€ã‚ã‚‹ç¨‹åº¦ã®åˆ¤æ–­åŠ›ãŒå¿…è¦
                    <br>é›£ã—ã„ï¼šè‰²ã®å·®ãŒå°ã•ã(CIEDE2000å€¤ 5ä»¥ä¸‹)ã€éå¸¸ã«ä¼¼ãŸè‰²
                    <br>ãƒ©ãƒ³ãƒ€ãƒ ï¼šå®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã§è¡¨ç¤ºæ•°ãŒç•°ãªã‚Šã¾ã™
                </div>
            </div>

            <!-- è‰²è¦šãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="settings-section">
                <h3>è‰²è¦šãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="colorblind-row">
                    <button id="normal-vision-btn" class="colorblind-btn active" onclick="setColorVisionMode('normal')">é€šå¸¸ã®è‰²è¦š</button>
                    <button id="protanopia-btn" class="colorblind-btn" onclick="setColorVisionMode('protanopia')">1å‹è‰²è¦šï¼ˆPå‹ï¼‰å‘ã‘</button>
                    <button id="deuteranopia-btn" class="colorblind-btn" onclick="setColorVisionMode('deuteranopia')">2å‹è‰²è¦šï¼ˆDå‹ï¼‰å‘ã‘</button>
                    <button id="tritanopia-btn" class="colorblind-btn" onclick="setColorVisionMode('tritanopia')">3å‹è‰²è¦šï¼ˆTå‹ï¼‰å‘ã‘</button>
                </div>

                <div class="colorblind-row">
                    <button id="simulate-protanopia-btn" class="colorblind-btn" onclick="setColorVisionMode('simulate-protanopia')">1å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                    <button id="simulate-deuteranopia-btn" class="colorblind-btn" onclick="setColorVisionMode('simulate-deuteranopia')">2å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                </div>

                <div class="settings-info">
                    é€šå¸¸ã®è‰²è¦šï¼šæ¨™æº–çš„ãªè‰²è¦šã®æ–¹å‘ã‘
                    <br>1å‹è‰²è¦šï¼ˆPå‹ï¼‰å‘ã‘ï¼šèµ¤è‰²ã®è­˜åˆ¥ãŒå›°é›£ãªæ–¹å‘ã‘ï¼ˆèµ¤è‰²ãŒæš—ãè¦‹ãˆã‚‹ï¼‰
                    <br>2å‹è‰²è¦šï¼ˆDå‹ï¼‰å‘ã‘ï¼šç·‘è‰²ã®è­˜åˆ¥ãŒå›°é›£ãªæ–¹å‘ã‘ï¼ˆç·‘è‰²ãŒæ˜ã‚‹ãè¦‹ãˆã‚‹ï¼‰
                    <br>3å‹è‰²è¦šï¼ˆTå‹ï¼‰å‘ã‘ï¼šé’è‰²ã®è­˜åˆ¥ãŒå›°é›£ãªæ–¹å‘ã‘ï¼ˆé’ã¨ç·‘ã®åŒºåˆ¥ãŒå›°é›£ï¼‰
                    <br>1å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼š1å‹è‰²è¦šï¼ˆPå‹ï¼‰ã®è¦‹ãˆæ–¹ã‚’ä½“é¨“
                    <br>2å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼š2å‹è‰²è¦šï¼ˆDå‹ï¼‰ã®è¦‹ãˆæ–¹ã‚’ä½“é¨“
                </div>
            </div>

            <!-- è¿½åŠ ã®è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="settings-section">
                <h3>è¿½åŠ è¨­å®š</h3>
                <!-- ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹è¨­å®š -->
                <div class="settings-row">
                    <button id="time-bonus-toggle" class="time-bonus-btn" onclick="toggleTimeBonus()">ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹: ã‚ªãƒ•</button>
                </div>
                <div class="settings-info">
                    ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ï¼šç´ æ—©ãæ­£è§£ã™ã‚‹ã¨ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆãŒç²å¾—ã§ãã¾ã™
                    <br>1.5ç§’ä»¥å†…ï¼š100%ãƒœãƒ¼ãƒŠã‚¹ / 3ç§’ä»¥å†…ï¼š50%ãƒœãƒ¼ãƒŠã‚¹ / 5ç§’ä»¥å†…ï¼š20%ãƒœãƒ¼ãƒŠã‚¹
                </div>

                <!-- ãƒ†ãƒ¼ãƒè¨­å®š -->
                <div class="settings-row">
                    <button id="theme-toggle" class="theme-btn light-mode" onclick="toggleTheme()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
                </div>
                <div class="settings-info">
                    ãƒ†ãƒ¼ãƒï¼šã‚²ãƒ¼ãƒ ã®å¤–è¦³ã‚’å¤‰æ›´ã—ã¾ã™
                </div>

                <!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è¨­å®š - ã“ã“ã«ç§»å‹• -->
                <div class="settings-row">
                    <button id="install-app">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                </div>
                <div class="settings-info">
                    ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼šã“ã®ã‚²ãƒ¼ãƒ ã‚’ã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
                    <br>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ãƒ—ãƒ¬ã‚¤å¯èƒ½ã«ãªã‚Šã¾ã™
                </div>
            </div>
        </div>
    </div>

    <script>
        let colors = [];
        let correctColor;
        let score = 0;
        let difficultyLevel = 'medium'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ™®é€š
        let consecutiveWrong = 0; // é€£ç¶šä¸æ­£è§£å›æ•°
        let isGameOver = false; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ©ã‚°
        let maxWrongAttempts = 3; // æœ€å¤§ä¸æ­£è§£å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        let consecutiveCorrect = 0; // é€£ç¶šæ­£è§£å›æ•°
        let scoreMultiplier = 1.0; // ã‚¹ã‚³ã‚¢å€ç‡
        let numColors = 6; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²æ•°
        let colorVisionMode = 'normal'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²è¦šãƒ¢ãƒ¼ãƒ‰
        let useColorPatterns = false; // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹
        let showColorNumbers = false; // æ•°å­—ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
        let gameMode = 'normal'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        let infiniteStreak = 0; // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã®é€£ç¶šæ­£è§£å›æ•°

        // ã‚¿ã‚¤ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢é–¢é€£
        let useTimeBonus = false; // ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹æ©Ÿèƒ½ã®ãƒ•ãƒ©ã‚°
        let startTime = null; // å•é¡Œé–‹å§‹æ™‚é–“
        let timeBonus = 0; // æ™‚é–“ãƒœãƒ¼ãƒŠã‚¹

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒãƒ—ã®å®Ÿè£…
        const colorCache = new Map();
        const labCache = new Map();
        const differenceCache = new Map();
        const cosCache = new Map();
        const sinCache = new Map();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDifficultyButtons();
            updateColorVisionButtons();
            updateGameModeButtons();
            updateTimeBonusButton();
            setupThemeToggle();
            setupModalHandlers(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚’åˆæœŸåŒ–
            setupCacheManagement();
            // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
            setupPWAInstall();
        });

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
        function setupPWAInstall() {
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
            let deferredPrompt;
            const installButton = document.getElementById('install-app');

            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç™ºç«æ™‚
            window.addEventListener('beforeinstallprompt', (e) => {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é˜²æ­¢
                e.preventDefault();
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
                deferredPrompt = e;
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                installButton.style.display = 'inline-block';
            });

            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;

                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                deferredPrompt.prompt();

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµæœã‚’å¾…æ©Ÿ
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çµæœ: ${outcome}`);

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯1å›ã—ã‹ä½¿ãˆãªã„ã®ã§ãƒªã‚»ãƒƒãƒˆ
                deferredPrompt = null;

                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                installButton.style.display = 'none';
            });

            // ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸæ™‚
            window.addEventListener('appinstalled', (e) => {
                console.log('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ');
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                installButton.style.display = 'none';
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
        function setupModalHandlers() {
            const modal = document.getElementById('settings-modal');
            const settingsButton = document.getElementById('settings-button');
            const closeButton = document.querySelector('.close-button');

            // è¨­å®šãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            settingsButton.addEventListener('click', function() {
                modal.style.display = 'block';
            });

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
            closeButton.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Escã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            });
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function setupThemeToggle() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ†ãƒ¼ãƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedTheme = localStorage.getItem('rgbGameTheme');

            // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒãŒã‚ã‚Œã°é©ç”¨
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('theme-toggle').textContent = 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                document.getElementById('theme-toggle').classList.remove('light-mode');
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('theme-toggle').textContent = 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
                document.getElementById('theme-toggle').classList.add('light-mode');
            }
        }

        // ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const themeToggle = document.getElementById('theme-toggle');

            if (document.body.classList.contains('dark-theme')) {
                themeToggle.textContent = 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                themeToggle.classList.remove('light-mode');
                localStorage.setItem('rgbGameTheme', 'dark');
            } else {
                themeToggle.textContent = 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
                themeToggle.classList.add('light-mode');
                localStorage.setItem('rgbGameTheme', 'light');
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function toggleTimeBonus() {
            useTimeBonus = !useTimeBonus;
            updateTimeBonusButton();

            // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹/åœæ­¢
            if (useTimeBonus) {
                document.getElementById('time-info').textContent = 'ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ä¸­...';
                startTime = Date.now();
            } else {
                document.getElementById('time-info').textContent = '';
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTimeBonusButton() {
            const toggleButton = document.getElementById('time-bonus-toggle');
            if (useTimeBonus) {
                toggleButton.textContent = 'ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹: ã‚ªãƒ³';
                toggleButton.classList.add('active');
            } else {
                toggleButton.textContent = 'ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹: ã‚ªãƒ•';
                toggleButton.classList.remove('active');
            }
        }

        // é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateDifficultyButtons() {
            // ã™ã¹ã¦ã®é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç¾åœ¨ã®é›£æ˜“åº¦ã«å¿œã˜ãŸãƒœã‚¿ãƒ³ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const activeBtn = document.getElementById(`${difficultyLevel}-btn`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateColorVisionButtons() {
            // ã™ã¹ã¦ã®è‰²è¦šãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.colorblind-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç¾åœ¨ã®è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒœã‚¿ãƒ³ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            let activeBtn;

            if (colorVisionMode === 'simulate-protanopia') {
                activeBtn = document.getElementById('simulate-protanopia-btn');
            } else if (colorVisionMode === 'simulate-deuteranopia') {
                activeBtn = document.getElementById('simulate-deuteranopia-btn');
            } else if (colorVisionMode === 'normal') {
                activeBtn = document.getElementById('normal-vision-btn');
            } else {
                // 1å‹ã€œ3å‹è‰²è¦šãƒ¢ãƒ¼ãƒ‰ï¼ˆprotanopia, deuteranopia, tritanopiaï¼‰
                activeBtn = document.getElementById(`${colorVisionMode}-btn`);
            }

            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateGameModeButtons() {
            // ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.game-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒœã‚¿ãƒ³ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const activeBtn = document.getElementById(`${gameMode}-mode-btn`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒ«èª¬æ˜ã‚’æ›´æ–°
            updateGameRules();
        }

        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒ«èª¬æ˜ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateGameRules() {
            const rulesElement = document.getElementById('game-rules');
            if (gameMode === 'normal') {
                rulesElement.textContent = 'æ³¨æ„ï¼šé€£ç¶šã§é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆç°¡å˜ï¼š2å›ã€æ™®é€šãƒ»é›£ã—ã„ï¼š3å›ï¼‰';
                document.getElementById('infinite-streak').textContent = '';
            } else if (gameMode === 'infinite') {
                rulesElement.textContent = 'ç„¡é™ãƒ¢ãƒ¼ãƒ‰ï¼šä¸æ­£è§£ã®å ´åˆã¯æ­£è§£ã‚’è¡¨ç¤ºã—ã¦æ¬¡ã¸é€²ã¿ã¾ã™ã€‚é€£ç¶šæ­£è§£æ•°ã«æŒ‘æˆ¦ï¼';
                document.getElementById('infinite-streak').textContent = 'é€£ç¶šæ­£è§£æ•°: 0';
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹é–¢æ•°
        function setGameMode(mode) {
            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (mode === gameMode) return;

            gameMode = mode;

            // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateGameModeButtons();

            // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã¯é€£ç¶šæ­£è§£æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (mode === 'infinite') {
                infiniteStreak = 0;
                document.getElementById('infinite-streak').textContent = 'é€£ç¶šæ­£è§£æ•°: 0';
                // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã™ã‚‹
                document.getElementById('score').style.display = 'none';
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’è¡¨ç¤ºã™ã‚‹
                document.getElementById('score').style.display = '';
            }

            // ã‚¹ã‚³ã‚¢ã¨ã‚³ãƒ³ãƒœã‚’ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: 0`;
            consecutiveCorrect = 0;
            document.getElementById('combo').textContent = '';

            // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetGame();

            // ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•çš„ã«é–‰ã˜ãªã„ã‚ˆã†ã«ï¼‰
            // document.getElementById('settings-modal').style.display = 'none';
        }

        // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹é–¢æ•°
        function setColorVisionMode(mode) {
            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (mode === colorVisionMode) return;

            colorVisionMode = mode;

            // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè¨­å®š
            switch(mode) {
                case 'normal':
                    useColorPatterns = false;
                    showColorNumbers = false;
                    break;
                case 'protanopia': // 1å‹è‰²è¦šï¼ˆPå‹ï¼‰å‘ã‘
                case 'deuteranopia': // 2å‹è‰²è¦šï¼ˆDå‹ï¼‰å‘ã‘
                case 'tritanopia': // 3å‹è‰²è¦šï¼ˆTå‹ï¼‰å‘ã‘
                    useColorPatterns = true;
                    showColorNumbers = true;
                    break;
                case 'simulate-protanopia': // 1å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                case 'simulate-deuteranopia': // 2å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    useColorPatterns = false;
                    showColorNumbers = false;
                    break;
            }

            // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateColorVisionButtons();

            // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetGame();

            // ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•çš„ã«é–‰ã˜ãªã„ã‚ˆã†ã«ï¼‰
            // document.getElementById('settings-modal').style.display = 'none';
        }

        // é›£æ˜“åº¦è¨­å®š
        function setDifficulty(level) {
            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹é›£æ˜“åº¦ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (level === difficultyLevel) return;

            difficultyLevel = level;

            // é›£æ˜“åº¦ã«å¿œã˜ã¦æœ€å¤§ä¸æ­£è§£å›æ•°ã¨è‰²ã®æ•°ã‚’è¨­å®š
            switch(level) {
                case 'easy':
                    maxWrongAttempts = 2; // ç°¡å˜ãƒ¢ãƒ¼ãƒ‰ã¯2å›ã¾ã§
                    numColors = 3;
                    break;
                case 'medium':
                    maxWrongAttempts = 3;
                    numColors = 6;
                    break;
                case 'hard':
                    maxWrongAttempts = 3;
                    numColors = 9;
                    break;
                case 'random3':
                    maxWrongAttempts = 2;
                    numColors = 3;
                    break;
                case 'random6':
                    maxWrongAttempts = 3;
                    numColors = 6;
                    break;
                case 'random9':
                    maxWrongAttempts = 3;
                    numColors = 9;
                    break;
            }

            // é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateDifficultyButtons();

            // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: 0`;
            resetGame();

            // ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•çš„ã«é–‰ã˜ãªã„ã‚ˆã†ã«ï¼‰
            // document.getElementById('settings-modal').style.display = 'none';
        }

        // RGBâ†’LABå¤‰æ›ã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function rgbToLabCached(rgb) {
            // RGBå€¤ã‚’ã‚­ãƒ¼ã¨ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
            const key = `${rgb[0]},${rgb[1]},${rgb[2]}`;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°ã€ãã‚Œã‚’è¿”ã™
            if (labCache.has(key)) {
                return labCache.get(key);
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‘ã‚Œã°è¨ˆç®—
            // RGBå€¤ã‚’0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
            let r = rgb[0] / 255;
            let g = rgb[1] / 255;
            let b = rgb[2] / 255;

            // sRGBã‹ã‚‰ãƒªãƒ‹ã‚¢RGBã¸ã®å¤‰æ›ï¼ˆæ¡ä»¶åˆ†å²ã‚’æ¸›ã‚‰ã™ãŸã‚ä¸‰é …æ¼”ç®—å­ã‚’ä½¿ç”¨ï¼‰
            r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

            // ãƒªãƒ‹ã‚¢RGBã‹ã‚‰XYZã¸ã®å¤‰æ›ï¼ˆè¡Œåˆ—æ¼”ç®—ã‚’æœ€é©åŒ–ï¼‰
            const x = r * 0.4124 + g * 0.3576 + b * 0.1805;
            const y = r * 0.2126 + g * 0.7152 + b * 0.0722;
            const z = r * 0.0193 + g * 0.1192 + b * 0.9505;

            // D65åŸºæº–ç™½è‰²ç‚¹
            const xn = 0.95047;
            const yn = 1.0;
            const zn = 1.08883;

            // XYZæ­£è¦åŒ–
            let xr = x / xn;
            let yr = y / yn;
            let zr = z / zn;

            // XYZâ†’LABå¤‰æ›å®šæ•°
            const epsilon = 0.008856;
            const kappa = 903.3;

            // å¤‰æ›é–¢æ•°ã®æœ€é©åŒ–ï¼ˆäº‹å‰è¨ˆç®—ã¨æ¡ä»¶åˆ†å²ã‚’æ¸›ã‚‰ã™ï¼‰
            const fx = xr > epsilon ? Math.cbrt(xr) : (kappa * xr + 16) / 116;
            const fy = yr > epsilon ? Math.cbrt(yr) : (kappa * yr + 16) / 116;
            const fz = zr > epsilon ? Math.cbrt(zr) : (kappa * zr + 16) / 116;

            const L = 116 * fy - 16;
            const a = 500 * (fx - fy);
            const bComponent = 200 * (fy - fz);

            const result = [L, a, bComponent];

            // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            labCache.set(key, result);

            return result;
        }

        // è¨ˆç®—ã‚³ã‚¹ãƒˆã®é«˜ã„æ“ä½œã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getCachedValue(cache, key, computeFunc) {
            if (cache.has(key)) {
                return cache.get(key);
            }
            const result = computeFunc();
            cache.set(key, result);
            return result;
        }

        function cachedCos(angle) {
            return getCachedValue(cosCache, angle, () => Math.cos(angle * Math.PI / 180));
        }

        function cachedSin(angle) {
            return getCachedValue(sinCache, angle, () => Math.sin(angle * Math.PI / 180));
        }

        // æœ€é©åŒ–ã•ã‚ŒãŸDeltaE2000é–¢æ•°
        function deltaE2000Optimized(lab1, lab2) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆé †ä¸åŒã§åŒã˜ã‚­ãƒ¼ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
            const cacheKey = lab1[0] <= lab2[0]
                ? `${lab1[0]},${lab1[1]},${lab1[2]}_${lab2[0]},${lab2[1]},${lab2[2]}`
                : `${lab2[0]},${lab2[1]},${lab2[2]}_${lab1[0]},${lab1[1]},${lab1[2]}`;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
            if (differenceCache.has(cacheKey)) {
                return differenceCache.get(cacheKey);
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‘ã‚Œã°è¨ˆç®—
            // å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å±•é–‹
            const L1 = lab1[0];
            const a1 = lab1[1];
            const b1 = lab1[2];
            const L2 = lab2[0];
            const a2 = lab2[1];
            const b2 = lab2[2];

            // é«˜é€ŸåŒ–ã®ãŸã‚ã®äº‹å‰è¨ˆç®—
            const a1Squared = a1 * a1;
            const b1Squared = b1 * b1;
            const a2Squared = a2 * a2;
            const b2Squared = b2 * b2;

            // ã‚¹ãƒ†ãƒƒãƒ—1: Cã‹ã‚‰C*ãŠã‚ˆã³hã®è¨ˆç®—
            const C1 = Math.sqrt(a1Squared + b1Squared);
            const C2 = Math.sqrt(a2Squared + b2Squared);
            const Cbar = (C1 + C2) / 2;

            // C^7ã‚’è¨ˆç®— (è‰²èª¿ã®é‡ã¿ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚)
            // å®šæ•°ã‚’ä½¿ç”¨ã—ã¦å¾®å°æœ€é©åŒ–
            const pow7 = 7;
            const C7 = Math.pow(Cbar, pow7);
            const G = 0.5 * (1 - Math.sqrt(C7 / (C7 + 6103515625))); // 25^7

            const a1p = a1 * (1 + G);
            const a2p = a2 * (1 + G);

            const a1pSquared = a1p * a1p;
            const a2pSquared = a2p * a2p;

            const C1p = Math.sqrt(a1pSquared + b1Squared);
            const C2p = Math.sqrt(a2pSquared + b2Squared);
            const Cbarp = (C1p + C2p) / 2;

            // h1pã¨h2pã‚’è¨ˆç®—ï¼ˆè‰²ç›¸è§’ï¼‰- ã‚¢ãƒ¼ã‚¯ã‚¿ãƒ³ã‚¸ã‚§ãƒ³ãƒˆã®è¨ˆç®—ã‚’æœ€é©åŒ–
            let h1p = Math.atan2(b1, a1p) * 180 / Math.PI;
            if (h1p < 0) h1p += 360;

            let h2p = Math.atan2(b2, a2p) * 180 / Math.PI;
            if (h2p < 0) h2p += 360;

            // è‰²ç›¸å·®ã®è¨ˆç®—ã‚’ç°¡ç•¥åŒ–
            let dhp;
            if (C1p * C2p === 0) {
                dhp = 0;
            } else {
                const hDiff = h2p - h1p;
                if (Math.abs(hDiff) <= 180) {
                    dhp = hDiff;
                } else if (hDiff > 180) {
                    dhp = hDiff - 360;
                } else {
                    dhp = hDiff + 360;
                }
            }

            // å¹³å‡è‰²ç›¸ã®è¨ˆç®—ã‚’ç°¡ç•¥åŒ–
            let Hbarp;
            if (C1p * C2p === 0) {
                Hbarp = h1p + h2p;
            } else {
                const hSum = h1p + h2p;
                if (Math.abs(h1p - h2p) <= 180) {
                    Hbarp = hSum / 2;
                } else if (hSum < 360) {
                    Hbarp = (hSum + 360) / 2;
                } else {
                    Hbarp = (hSum - 360) / 2;
                }
            }

            // é‡ã¿ä¿‚æ•°ã®è¨ˆç®—
            // ä¸‰è§’é–¢æ•°è¨ˆç®—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
            const T = 1 - 0.17 * cachedCos(Hbarp - 30)
                      + 0.24 * cachedCos(2 * Hbarp)
                      + 0.32 * cachedCos(3 * Hbarp + 6)
                      - 0.20 * cachedCos(4 * Hbarp - 63);

            const dTheta = 30 * Math.exp(-Math.pow((Hbarp - 275) / 25, 2));

            const RC = 2 * Math.sqrt(C7 / (C7 + 6103515625)); // 25^7

            const Lmean = (L1 + L2) / 2;
            const LmeanMinus50Squared = Math.pow(Lmean - 50, 2);
            const SL = 1 + (0.015 * LmeanMinus50Squared) / Math.sqrt(20 + LmeanMinus50Squared);

            const SC = 1 + 0.045 * Cbarp;
            const SH = 1 + 0.015 * Cbarp * T;

            const RT = -cachedSin(2 * dTheta) * RC;

            // è‰²å·®æˆåˆ†ã®è¨ˆç®—
            const dL = L2 - L1;
            const dCp = C2p - C1p;
            const dHp = 2 * Math.sqrt(C1p * C2p) * cachedSin(dhp / 2);

            // æœ€çµ‚çš„ãªè‰²å·®ã®è¨ˆç®—
            const dLSL = dL / SL;
            const dCpSC = dCp / SC;
            const dHpSH = dHp / SH;

            const dE00 = Math.sqrt(
                dLSL * dLSL +
                dCpSC * dCpSC +
                dHpSH * dHpSH +
                RT * dCpSC * dHpSH
            );

            // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            differenceCache.set(cacheKey, dE00);

            return dE00;
        }

        // ç°¡ç•¥ç‰ˆã®è‰²å·®è¨ˆç®—ï¼ˆéå¸¸ã«é«˜é€Ÿã ãŒç²¾åº¦ã¯è‹¥å¹²ä½ã„ï¼‰- é¸æŠçš„ã«ä½¿ç”¨å¯èƒ½
        function fastColorDifference(color1, color2) {
            // RGBå€¤ã®å˜ç´”ãªå·®
            const rDiff = Math.abs(color1[0] - color2[0]);
            const gDiff = Math.abs(color1[1] - color2[1]);
            const bDiff = Math.abs(color1[2] - color2[2]);

            // äººé–“ã®è¦–è¦šã¯ç·‘ã«æœ€ã‚‚æ•æ„Ÿã§ã€é’ã«æœ€ã‚‚éˆæ„Ÿ
            // é‡ã¿ä»˜ã‘ã—ãŸè‰²å·®ï¼ˆç°¡æ˜“çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
            return Math.sqrt(rDiff * rDiff * 0.3 + gDiff * gDiff * 0.59 + bDiff * bDiff * 0.11);
        }

        // è‰²è¦šã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²å·®è¨ˆç®—ã‚’è¡Œã†é–¢æ•°
        function colorDifferenceForColorVision(color1, color2, colorVisionMode) {
            // é€šå¸¸ã®è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã§ã¯èª¿æ•´ãªã—
            if (colorVisionMode === 'normal') {
                return colorDifferenceOptimized(color1, color2);
            }

            // è‰²è¦šç•°å¸¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸé‡ã¿ã¥ã‘
            let rWeight = 0.3;
            let gWeight = 0.59;
            let bWeight = 0.11;

            switch(colorVisionMode) {
                case 'protanopia': // 1å‹è‰²è¦šï¼ˆPå‹ï¼‰- èµ¤ãŒè¦‹ãˆã«ãã„
                    rWeight = 0.1;   // èµ¤ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    gWeight = 0.7;   // ç·‘ã®é‡ã¿ã‚’ä¸Šã’ã‚‹
                    bWeight = 0.2;   // é’ã®é‡ã¿ã‚’å°‘ã—ä¸Šã’ã‚‹
                    break;
                case 'deuteranopia': // 2å‹è‰²è¦šï¼ˆDå‹ï¼‰- ç·‘ãŒè¦‹ãˆã«ãã„
                    rWeight = 0.4;   // èµ¤ã®é‡ã¿ã‚’ä¸Šã’ã‚‹
                    gWeight = 0.4;   // ç·‘ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    bWeight = 0.2;   // é’ã®é‡ã¿ã‚’å°‘ã—ä¸Šã’ã‚‹
                    break;
                case 'tritanopia': // 3å‹è‰²è¦šï¼ˆTå‹ï¼‰- é’ãŒè¦‹ãˆã«ãã„
                    rWeight = 0.3;   // èµ¤ã¯ãã®ã¾ã¾
                    gWeight = 0.6;   // ç·‘ã‚’å°‘ã—ä¸Šã’ã‚‹
                    bWeight = 0.1;   // é’ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    break;
                case 'simulate-protanopia': // 1å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    rWeight = 0.2;   // èµ¤ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    gWeight = 0.7;   // ç·‘ã®é‡ã¿ã‚’ä¸Šã’ã‚‹
                    bWeight = 0.1;   // é’ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    break;
                case 'simulate-deuteranopia': // 2å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    rWeight = 0.4;   // èµ¤ã®é‡ã¿ã‚’ä¸Šã’ã‚‹
                    gWeight = 0.3;   // ç·‘ã®é‡ã¿ã‚’ä¸‹ã’ã‚‹
                    bWeight = 0.3;   // é’ã®é‡ã¿ã‚’ä¸Šã’ã‚‹
                    break;
            }

            // RGBå€¤ã®å˜ç´”ãªå·®ï¼ˆå„è‰²è¦šã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸé‡ã¿ä»˜ã‘ï¼‰
            const rDiff = Math.abs(color1[0] - color2[0]);
            const gDiff = Math.abs(color1[1] - color2[1]);
            const bDiff = Math.abs(color1[2] - color2[2]);

            // è‰²è¦šã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦é‡ã¿ä»˜ã‘ã—ãŸè‰²å·®
            return Math.sqrt(rDiff * rDiff * rWeight + gDiff * gDiff * gWeight + bDiff * bDiff * bWeight);
        }

        // æœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³ã®è‰²å·®è¨ˆç®—é–¢æ•°
        function colorDifferenceOptimized(color1, color2) {
            // è‰²ã®RGBå€¤ã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆé †ä¸åŒã§åŒã˜ã‚­ãƒ¼ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
            const cacheKey =
                color1[0] <= color2[0] || (color1[0] === color2[0] && color1[1] <= color2[1]) ||
                (color1[0] === color2[0] && color1[1] === color2[1] && color1[2] <= color2[2])
                    ? `${color1[0]},${color1[1]},${color1[2]}_${color2[0]},${color2[1]},${color2[2]}`
                    : `${color2[0]},${color2[1]},${color2[2]}_${color1[0]},${color1[1]},${color1[2]}`;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
            if (colorCache.has(cacheKey)) {
                return colorCache.get(cacheKey);
            }

            // LABè‰²ç©ºé–“ã«å¤‰æ›
            const lab1 = rgbToLabCached(color1);
            const lab2 = rgbToLabCached(color2);

            // è‰²å·®ã‚’è¨ˆç®—
            const diff = deltaE2000Optimized(lab1, lab2);

            // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            colorCache.set(cacheKey, diff);

            return diff;
        }

        // é›£æ˜“åº¦ã«åŸºã¥ã„ã¦ã©ã®è‰²å·®é–¢æ•°ã‚’ä½¿ã†ã‹æ±ºå®šã™ã‚‹é–¢æ•°
        function chooseDifferenceFunction(difficultyLevel, colorVisionMode) {
            // è‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å°‚ç”¨ã®é–¢æ•°ã‚’ä½¿ç”¨
            if (colorVisionMode !== 'normal') {
                return (color1, color2) => colorDifferenceForColorVision(color1, color2, colorVisionMode);
            }

            // é›£ã—ã„ãƒ¢ãƒ¼ãƒ‰ã§ã¯é«˜ç²¾åº¦ãŒå¿…è¦
            if (difficultyLevel === 'hard') {
                return colorDifferenceOptimized;
            }
            // ãã‚Œä»¥å¤–ã®å ´åˆã¯é«˜é€Ÿç‰ˆã‚’ä½¿ç”¨å¯èƒ½
            return fastColorDifference;
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function limitCacheSize(cache, maxSize = 1000) {
            if (cache.size > maxSize) {
                // LRUçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šå¤ã„ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
                const keysToDelete = Array.from(cache.keys()).slice(0, Math.floor(cache.size / 2));
                keysToDelete.forEach(key => cache.delete(key));
            }
        }

        // å®šæœŸçš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ã—åˆ¶é™ã™ã‚‹
        function setupCacheManagement() {
            const checkCaches = () => {
                limitCacheSize(colorCache);
                limitCacheSize(labCache);
                limitCacheSize(differenceCache);
                limitCacheSize(cosCache);
                limitCacheSize(sinCache);
            };

            // 5ç§’ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
            setInterval(checkCaches, 5000);
        }

        // å…ƒã®ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function generateRandomColor() {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgb(${r}, ${g}, ${b})`;
        }

        // è‰²è¦šã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦è‰²ã‚’èª¿æ•´ã™ã‚‹é–¢æ•°
        function adjustColorForColorVision(rgbColor, colorVisionMode) {
            // é€šå¸¸ã®è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã§ã¯èª¿æ•´ãªã—
            if (colorVisionMode === 'normal') {
                return rgbColor;
            }

            // æ–‡å­—åˆ—ã‹ã‚‰RGBå€¤ã‚’å–å¾—
            const colorRegex = /rgb\((\d+),\s*(\d+),\s*(\d+)\)/;
            const match = rgbColor.match(colorRegex);
            if (!match) return rgbColor;

            const r = parseInt(match[1]);
            const g = parseInt(match[2]);
            const b = parseInt(match[3]);

            // è‰²è¦šã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸèª¿æ•´
            let adjustedR = r;
            let adjustedG = g;
            let adjustedB = b;

            switch(colorVisionMode) {
                case 'protanopia': // 1å‹è‰²è¦šï¼ˆPå‹ï¼‰å‘ã‘ - èµ¤ãŒè¦‹ãˆã«ãã„äººå‘ã‘ã«èª¿æ•´
                    // èµ¤ã¨ç·‘ã®å·®ã‚’å¼·èª¿
                    if (r > g) {
                        adjustedR = Math.min(255, r + 30);
                        adjustedG = Math.max(0, g - 20);
                    } else if (g > r) {
                        adjustedR = Math.max(0, r - 20);
                        adjustedG = Math.min(255, g + 30);
                    }
                    // æ˜æš—ã®å·®ã‚’å¼·èª¿
                    adjustedB = Math.min(255, Math.max(0, b + Math.floor((r - g) / 2)));
                    break;

                case 'deuteranopia': // 2å‹è‰²è¦šï¼ˆDå‹ï¼‰å‘ã‘ - ç·‘ãŒè¦‹ãˆã«ãã„äººå‘ã‘ã«èª¿æ•´
                    // èµ¤ã¨ç·‘ã®å·®ã‚’å¼·èª¿
                    if (r > g) {
                        adjustedR = Math.min(255, r + 40);
                        adjustedG = Math.max(0, g - 30);
                    } else if (g > r) {
                        adjustedR = Math.max(0, r - 30);
                        adjustedG = Math.min(255, g + 40);
                    }
                    // é’ã‚’å°‘ã—å¼·èª¿
                    adjustedB = Math.min(255, Math.max(0, b + 20));
                    break;

                case 'tritanopia': // 3å‹è‰²è¦šï¼ˆTå‹ï¼‰å‘ã‘ - é’ãŒè¦‹ãˆã«ãã„äººå‘ã‘ã«èª¿æ•´
                    // é’ã¨ç·‘ã®å·®ã‚’å¼·èª¿
                    if (b > g) {
                        adjustedB = Math.min(255, b + 40);
                        adjustedG = Math.max(0, g - 20);
                    } else if (g > b) {
                        adjustedB = Math.max(0, b - 20);
                        adjustedG = Math.min(255, g + 30);
                    }
                    // èµ¤ã‚’ã‚„ã‚„å¼·èª¿
                    adjustedR = Math.min(255, Math.max(0, r + 20));
                    break;

                case 'simulate-protanopia': // 1å‹è‰²è¦šï¼ˆPå‹ï¼‰ã®è¦‹ãˆæ–¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    // èµ¤è‰²ã®æˆåˆ†ã‚’å¼±ã‚ã‚‹ï¼ˆèµ¤ãŒè¦‹ãˆã«ãã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    // På‹ã®æ•°å­¦çš„ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    adjustedR = Math.round(0.1 * r + 0.9 * g);
                    adjustedG = Math.round(0.1 * r + 0.9 * g);
                    adjustedB = b;
                    break;

                case 'simulate-deuteranopia': // 2å‹è‰²è¦šï¼ˆDå‹ï¼‰ã®è¦‹ãˆæ–¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    // ç·‘è‰²ã®æˆåˆ†ã‚’å¼±ã‚ã‚‹ï¼ˆç·‘ãŒè¦‹ãˆã«ãã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    // Då‹ã®æ•°å­¦çš„ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    adjustedR = Math.round(0.8 * r + 0.2 * g);
                    adjustedG = Math.round(0.2 * r + 0.8 * g);
                    adjustedB = b;
                    break;
            }

            return `rgb(${adjustedR}, ${adjustedG}, ${adjustedB})`;
        }

        // é›£æ˜“åº¦ã«åŸºã¥ã„ã¦è‰²ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã™ã‚‹é–¢æ•°
        function generateColorByDifficulty(difficultyLevel, previousColors = []) {
            // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã¯å…ƒã®é–¢æ•°ã‚’ä½¿ç”¨
            if (difficultyLevel === 'random3' || difficultyLevel === 'random6' || difficultyLevel === 'random9') {
                return generateRandomColor();
            }

            // åŸºæœ¬ã®ãƒ©ãƒ³ãƒ€ãƒ è‰²ç”Ÿæˆ
            function getRandomRGB() {
                const r = Math.floor(Math.random() * 256);
                const g = Math.floor(Math.random() * 256);
                const b = Math.floor(Math.random() * 256);
                return [r, g, b];
            }

            // é›£æ˜“åº¦ã«åŸºã¥ã„ãŸè‰²ã®å·®ã®é–¾å€¤ï¼ˆCIEDE2000ç”¨ã«èª¿æ•´ï¼‰
            // CIEDE2000å€¤ã®å‚è€ƒ:
            // 0-1: çŸ¥è¦šã§ããªã„å·®ï¼ˆåŒä¸€è‰²ã¨è¦‹ãªã›ã‚‹ï¼‰
            // 1-2: ã‚ãšã‹ãªå·®ï¼ˆç†Ÿç·´è€…ã®ã¿åŒºåˆ¥å¯èƒ½ï¼‰
            // 2-5: å¾®å¦™ãªå·®ï¼ˆæ³¨æ„ã™ã‚Œã°åŒºåˆ¥å¯èƒ½ï¼‰
            // 5-10: æ˜ç¢ºãªå·®ï¼ˆå®¹æ˜“ã«åŒºåˆ¥å¯èƒ½ï¼‰
            // 10+: éå¸¸ã«æ˜ç¢ºãªå·®ï¼ˆèª°ã§ã‚‚åŒºåˆ¥å¯èƒ½ï¼‰
            let threshold;
            if (difficultyLevel === 'easy') {
                threshold = 10; // ç°¡å˜ï¼šéå¸¸ã«æ˜ç¢ºãªå·®
            } else if (difficultyLevel === 'hard') {
                threshold = 5;  // é›£ã—ã„ï¼šå¾®å¦™ãªå·®
            } else {
                threshold = 7;  // æ™®é€šï¼šé©åº¦ãªå·®
            }

            // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦é–¾å€¤ã‚’èª¿æ•´
            if (colorVisionMode !== 'normal') {
                // è‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯å·®ã‚’ã‚ˆã‚Šæ˜ç¢ºã«ã™ã‚‹
                threshold = threshold * 1.5;
            }

            let newColor, isValid, attempts = 0;
            const maxAttempts = 25; // æœ€å¤§è©¦è¡Œå›æ•°

            do {
                newColor = getRandomRGB();
                isValid = true;

                // æ—¢å­˜ã®è‰²ã¨ã®å·®ã‚’ç¢ºèªï¼ˆ1è‰²ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (previousColors.length > 0) {
                    for (let i = 0; i < previousColors.length; i++) {
                        const prev = previousColors[i];
                        // æ–‡å­—åˆ—ã‹ã‚‰RGBå€¤ã‚’å–å¾—
                        const prevR = parseInt(prev.substring(4, prev.indexOf(',')));
                        const prevG = parseInt(prev.substring(prev.indexOf(',') + 1, prev.lastIndexOf(',')));
                        const prevB = parseInt(prev.substring(prev.lastIndexOf(',') + 1, prev.indexOf(')')));

                        // æœ€é©åŒ–ã—ãŸè‰²å·®è¨ˆç®—é–¢æ•°ã‚’ä½¿ç”¨
                        const diffFunc = chooseDifferenceFunction(difficultyLevel, colorVisionMode);
                        const diff = diffFunc(newColor, [prevR, prevG, prevB]);

                        // é›£æ˜“åº¦ã«åŸºã¥ã„ã¦è‰²ã®å·®ã‚’ç¢ºèª
                        if (difficultyLevel === 'easy' && diff < threshold) {
                            // ç°¡å˜ãƒ¢ãƒ¼ãƒ‰ï¼šè‰²ãŒä¼¼ã™ãã¦ã„ã‚‹å ´åˆã¯ä¸é©
                            isValid = false;
                            break;
                        } else if (difficultyLevel === 'hard' && diff > threshold) {
                            // é›£ã—ã„ãƒ¢ãƒ¼ãƒ‰ï¼šè‰²ã®å·®ãŒå¤§ãã™ãã‚‹å ´åˆã¯ä¸é©
                            isValid = false;
                            break;
                        }
                    }
                }

                attempts++;
                // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆã¯ã€ç¾åœ¨ã®è‰²ã‚’ä½¿ç”¨
                if (attempts >= maxAttempts) {
                    console.log("æ³¨: è©¦è¡Œå›æ•° " + attempts + "å›ã§æœ€é©ãªè‰²ãŒè¦‹ã¤ã‹ã‚‰ãšã€ç¾åœ¨ã®è‰²ã‚’ä½¿ç”¨ã—ã¾ã™");
                    break;
                }
            } while (!isValid && previousColors.length > 0);

            return `rgb(${newColor[0]}, ${newColor[1]}, ${newColor[2]})`;
        }

        // è‰²ã®é…åˆ—ã‚’ç”Ÿæˆ
        function generateColors(num) {
            const arr = [];
            for (let i = 0; i < num; i++) {
                // ç¾åœ¨ã®é›£æ˜“åº¦ã«åŸºã¥ã„ã¦è‰²ã‚’ç”Ÿæˆ
                arr.push(generateColorByDifficulty(difficultyLevel, arr));
            }
            return arr;
        }

        // é…åˆ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
        function pickColor() {
            const random = Math.floor(Math.random() * colors.length);
            return colors[random];
        }

        // è‰²ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã™ã‚‹é–¢æ•°
        function getRandomPattern() {
            const patterns = ['pattern-lines', 'pattern-dots', 'pattern-grid'];
            const randomIndex = Math.floor(Math.random() * patterns.length);
            return patterns[randomIndex];
        }

        // æ­£è§£ã®è‰²ã‚’è¡¨ç¤ºã™ã‚‹
        function showCorrectAnswer() {
            const squares = document.querySelectorAll('.color-square');
            let position = "";
            let correctIndex = -1;

            // æ­£è§£ã®è‰²ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
            for (let i = 0; i < colors.length; i++) {
                if (colors[i] === correctColor) {
                    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
                    correctIndex = i;
                    // ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è‰²ã‚¹ã‚¯ã‚¨ã‚¢ã‚’å¼·èª¿è¡¨ç¤º
                    squares[i].classList.add('correct-color');
                    squares[i].style.opacity = '1'; // æ­£è§£ã®è‰²ã¯å®Œå…¨ã«è¡¨ç¤º
                    break;
                }
            }

            // é›£æ˜“åº¦ã«å¿œã˜ãŸä½ç½®è¡¨ç¾ã‚’è¨­å®š
            if (numColors === 3) { // 3è‰²ã®å ´åˆ
                if (correctIndex === 0) position = "å·¦";
                else if (correctIndex === 1) position = "ä¸­å¤®";
                else position = "å³";
            } else { // 6è‰²ã¾ãŸã¯9è‰²ã®å ´åˆ
                const row = Math.floor(correctIndex / 3) + 1;
                const col = (correctIndex % 3) + 1;
                position = `${row}è¡Œç›®ã®${col}ç•ªç›®`;
            }

            document.getElementById('message').textContent = `æ­£è§£ã¯${position}ã®è‰²ã§ã™ï¼`;
            document.getElementById('message').style.color = '#ff9800';
        }

        // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æ­£è§£è¡¨ç¤ºé–¢æ•°
        function showCorrectAnswerInfiniteMode() {
            showCorrectAnswer(); // æ­£è§£ã®è‰²ã‚’è¡¨ç¤º

            // 1ç§’å¾Œã«æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                resetGame();
            }, 1000);
        }

        // åŒã˜å•é¡Œã‚’å†è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆç¢ºèªç”¨ï¼‰
        function retryProblem() {
            document.getElementById('message').textContent = 'ç¢ºèªãƒ¢ãƒ¼ãƒ‰: å›ç­”ã¯ã§ãã¾ã›ã‚“';
            document.getElementById('message').className = '';
            document.getElementById('message').style.color = 'blue';

            // ã™ã¹ã¦ã®è‰²ã‚¹ã‚¯ã‚¨ã‚¢ã‚’å†è¡¨ç¤ºã™ã‚‹ãŒã€ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡åŠ¹ã®ã¾ã¾
            const squares = document.querySelectorAll('.color-square');
            squares.forEach(square => {
                square.style.opacity = '1';
                square.classList.remove('correct-color');
                // å…ƒã®è‰²ã«æˆ»ã™ï¼ˆä¸æ­£è§£ã§è‰²ãŒå¤‰ã‚ã£ã¦ã„ã‚‹å ´åˆï¼‰
                const index = Array.from(squares).indexOf(square);
                if (index < colors.length) {
                    square.style.backgroundColor = colors[index];
                }
                // ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡åŠ¹ã®ã¾ã¾
                square.style.pointerEvents = 'none';
            });

            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç®¡ç†
            document.getElementById('retry-problem').style.display = 'none';
            // æ­£è§£ç¢ºèªãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã—ãŸã¾ã¾
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function gameOver() {
            isGameOver = true;
            document.getElementById('message').textContent = `ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼${maxWrongAttempts}å›é€£ç¶šã§é–“é•ãˆã¾ã—ãŸ`;
            document.getElementById('message').className = 'game-over';

            // ã‚¿ã‚¤ãƒ æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            if (useTimeBonus) {
                document.getElementById('time-info').textContent = '';
            }

            // ã™ã¹ã¦ã®è‰²ã‚¹ã‚¯ã‚¨ã‚¢ã‚’ç„¡åŠ¹åŒ–
            const squares = document.querySelectorAll('.color-square');
            squares.forEach(square => {
                square.style.pointerEvents = 'none';
                square.style.opacity = '0.5';
            });

            // æ­£è§£ç¢ºèªãƒœã‚¿ãƒ³ã¨å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('show-correct').style.display = 'inline-block';
            document.getElementById('retry-problem').style.display = 'inline-block';
            document.getElementById('share-score').style.display = 'inline-block';
        }

        // è‰²ã®ã‚¹ã‚¯ã‚¨ã‚¢ã‚’ä½œæˆ
        function setupSquares() {
            const container = document.getElementById('color-container');
            container.innerHTML = '';

            colors = generateColors(numColors);
            correctColor = pickColor();

            document.getElementById('rgb-display').textContent = correctColor.toUpperCase();

            // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒªã‚»ãƒƒãƒˆã¨é–‹å§‹
            if (useTimeBonus) {
                startTime = Date.now();
                document.getElementById('time-info').textContent = 'ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ä¸­...';
            } else {
                document.getElementById('time-info').textContent = '';
            }

            for (let i = 0; i < numColors; i++) {
                const square = document.createElement('div');
                square.className = 'color-square';

                // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦è‰²ã‚’èª¿æ•´
                const adjustedColor = adjustColorForColorVision(colors[i], colorVisionMode);
                square.style.backgroundColor = adjustedColor;

                // è‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
                if (useColorPatterns) {
                    const pattern = document.createElement('div');
                    pattern.className = `color-pattern ${getRandomPattern()}`;
                    square.appendChild(pattern);
                }

                // æ•°å­—ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆè‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
                if (showColorNumbers) {
                    const numberLabel = document.createElement('div');
                    numberLabel.className = 'color-number';
                    numberLabel.textContent = (i + 1).toString();
                    square.appendChild(numberLabel);
                }

                square.addEventListener('click', function() {
                    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
                    if (isGameOver) return;

                    // æ—¢ã«ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ã®ã‚¹ã‚¯ã‚¨ã‚¢ã¯ç„¡è¦–
                    if (this.classList.contains('clicked')) return;

                    // ã“ã®ã‚¹ã‚¯ã‚¨ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
                    this.classList.add('clicked');

                    const clickedColor = this.style.backgroundColor;

                    if (clickedColor === adjustColorForColorVision(correctColor, colorVisionMode)) {
                        // æ­£è§£ã®å ´åˆ
                        // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹
                        if (gameMode === 'normal') {
                            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
                            document.getElementById('message').textContent = 'æ­£è§£ï¼';
                            document.getElementById('message').style.color = 'green';
                            document.getElementById('message').className = '';

                            // é›£æ˜“åº¦ã”ã¨ã®åŸºæœ¬ã‚¹ã‚³ã‚¢
                            let basePoints;
                            switch(difficultyLevel) {
                                case 'easy':
                                case 'random3':
                                    basePoints = 5;
                                    break;
                                case 'hard':
                                case 'random9':
                                    basePoints = 15;
                                    break;
                                default: // medium, random6
                                    basePoints = 10;
                                    break;
                            }

                            // è‰²è¦šç•°å¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
                            if (colorVisionMode !== 'normal') {
                                basePoints = Math.round(basePoints * 1.2); // 20%ãƒœãƒ¼ãƒŠã‚¹
                            }

                            // é€£ç¶šæ­£è§£å›æ•°ã‚’æ›´æ–°
                            consecutiveCorrect++;

                            // ã‚¹ã‚³ã‚¢è¨ˆç®—ã¨è¡¨ç¤ºæ›´æ–°
                            let earnedPoints;

                            if (consecutiveCorrect === 1) {
                                // 1å›ç›®ã¯åŸºæœ¬ç‚¹æ•°ã®ã¿
                                earnedPoints = basePoints;
                            } else {
                                // 2å›ç›®ä»¥é™ã¯ãƒœãƒ¼ãƒŠã‚¹é©ç”¨
                                scoreMultiplier = 1 + ((consecutiveCorrect - 1) / 10);
                                earnedPoints = Math.round(basePoints * scoreMultiplier);
                            }

                            // ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ã®è¨ˆç®—ï¼ˆæœ‰åŠ¹æ™‚ã®ã¿ï¼‰
                            timeBonus = 0;
                            let responseTime = '';

                            if (useTimeBonus && startTime) {
                                const endTime = Date.now();
                                const timeElapsed = (endTime - startTime) / 1000; // ç§’å˜ä½
                                responseTime = timeElapsed.toFixed(2) + 'ç§’';

                                // æ™‚é–“ã«å¿œã˜ãŸãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
                                if (timeElapsed <= 1.5) {
                                    timeBonus = Math.round(basePoints * 1.0); // è¶…é€Ÿï¼š100%ãƒœãƒ¼ãƒŠã‚¹
                                    document.getElementById('time-info').textContent =
                                        `å¿œç­”æ™‚é–“: ${responseTime} - è¶…é€Ÿãƒœãƒ¼ãƒŠã‚¹: +${timeBonus}ç‚¹!`;
                                } else if (timeElapsed <= 3) {
                                    timeBonus = Math.round(basePoints * 0.5); // é€Ÿã„ï¼š50%ãƒœãƒ¼ãƒŠã‚¹
                                    document.getElementById('time-info').textContent =
                                        `å¿œç­”æ™‚é–“: ${responseTime} - é€Ÿã•ãƒœãƒ¼ãƒŠã‚¹: +${timeBonus}ç‚¹!`;
                                } else if (timeElapsed <= 5) {
                                    timeBonus = Math.round(basePoints * 0.2); // æ¨™æº–ï¼š20%ãƒœãƒ¼ãƒŠã‚¹
                                    document.getElementById('time-info').textContent =
                                        `å¿œç­”æ™‚é–“: ${responseTime} - ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹: +${timeBonus}ç‚¹`;
                                } else {
                                    document.getElementById('time-info').textContent =
                                        `å¿œç­”æ™‚é–“: ${responseTime} - ãƒœãƒ¼ãƒŠã‚¹ãªã—`;
                                }

                                // ç·ç²å¾—ãƒã‚¤ãƒ³ãƒˆã«ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ã‚’è¿½åŠ 
                                earnedPoints += timeBonus;
                            }

                            score += earnedPoints;
                            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: ${score}`;

                            // ã‚³ãƒ³ãƒœè¡¨ç¤ºã®æ›´æ–°
                            if (consecutiveCorrect > 1) {
                                const comboText = `${consecutiveCorrect} ã‚³ãƒ³ãƒœ! (${scoreMultiplier.toFixed(1)}å€ãƒœãƒ¼ãƒŠã‚¹)`;
                                document.getElementById('combo').textContent = `${comboText} +${earnedPoints}ç‚¹`;
                            } else {
                                document.getElementById('combo').textContent = `+${earnedPoints}ç‚¹`;
                            }

                            consecutiveWrong = 0; // é€£ç¶šä¸æ­£è§£å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ

                            // æ­£è§£å¾Œã«å…¨ã¦ã®è‰²ã‚¹ã‚¯ã‚¨ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ã«ã™ã‚‹
                            const allSquares = document.querySelectorAll('.color-square');
                            allSquares.forEach(square => {
                                square.style.pointerEvents = 'none';
                            });

                            // æ­£è§£ã®ã‚¹ã‚¯ã‚¨ã‚¢ã®æ ç·šã‚’è¿½åŠ ã—ãªã„
                            this.classList.remove('clicked'); // æ­£è§£ã®ãƒã‚¹ã¯æš—ãã—ãªã„
                            this.style.opacity = '1'; // æ­£è§£ã®ãƒã‚¹ã¯å®Œå…¨ã«è¡¨ç¤º

                            setTimeout(resetGame, 1500);
                        } else if (gameMode === 'infinite') {
                            // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
                            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãªã—

                            // é€£ç¶šæ­£è§£æ•°ã‚’æ›´æ–°
                            infiniteStreak++;
                            document.getElementById('infinite-streak').textContent = `é€£ç¶šæ­£è§£æ•°: ${infiniteStreak}`;

                            // ã‚¹ã‚³ã‚¢æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªåŠ ç®—ï¼‰
                            let basePoints;
                            switch(difficultyLevel) {
                                case 'easy':
                                case 'random3':
                                    basePoints = 5;
                                    break;
                                case 'hard':
                                case 'random9':
                                    basePoints = 15;
                                    break;
                                default: // medium, random6
                                    basePoints = 10;
                                    break;
                            }

                            // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒœãƒ¼ãƒŠã‚¹
                            const streakMultiplier = 1 + (infiniteStreak / 20); // 20å•ã”ã¨ã«1.0å€ãšã¤ä¸Šæ˜‡
                            const earnedPoints = Math.round(basePoints * streakMultiplier);
                            score += earnedPoints;
                            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: ${score}`;

                            // ã™ãã«æ¬¡ã®å•é¡Œã¸
                            resetGame();
                        }
                    } else {
                        // ä¸æ­£è§£ã®å ´åˆ
                        this.style.backgroundColor = '#f0f0f0'; // ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´
                        this.style.opacity = '0.5'; // åŠé€æ˜ã«

                        if (gameMode === 'normal') {
                            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
                            consecutiveWrong++; // é€£ç¶šä¸æ­£è§£å›æ•°ã‚’å¢—ã‚„ã™
                            consecutiveCorrect = 0; // é€£ç¶šæ­£è§£å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                            document.getElementById('combo').textContent = ''; // ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢

                            // ã‚¿ã‚¤ãƒ æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹æœ‰åŠ¹æ™‚ï¼‰
                            if (useTimeBonus) {
                                document.getElementById('time-info').textContent = '';
                            }

                            if (consecutiveWrong >= maxWrongAttempts) {
                                gameOver();
                            } else {
                                document.getElementById('message').textContent = `ä¸æ­£è§£...ã‚‚ã†ä¸€åº¦ï¼(${consecutiveWrong}/${maxWrongAttempts})`;
                                document.getElementById('message').style.color = 'red';
                                document.getElementById('message').className = '';
                                if (score > 0) score -= 2;
                                document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
                            }
                        } else if (gameMode === 'infinite') {
                            // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
                            document.getElementById('message').textContent = 'ä¸æ­£è§£ï¼';
                            document.getElementById('message').style.color = 'red';

                            // é€£ç¶šæ­£è§£æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                            infiniteStreak = 0;
                            document.getElementById('infinite-streak').textContent = `é€£ç¶šæ­£è§£æ•°: ${infiniteStreak}`;

                            // ã™ã¹ã¦ã®ã‚¹ã‚¯ã‚¨ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ã«
                            const allSquares = document.querySelectorAll('.color-square');
                            allSquares.forEach(square => {
                                square.style.pointerEvents = 'none';
                            });

                            // æ­£è§£ã‚’è¡¨ç¤ºã—ã¦3ç§’å¾Œã«æ¬¡ã®å•é¡Œã¸
                            showCorrectAnswerInfiniteMode();
                        }
                    }
                });

                container.appendChild(square);
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = '';
            document.getElementById('message').style.color = ''; // è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ

            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            if (gameMode === 'normal') {
                document.getElementById('combo').textContent = ''; // ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            }

            // ã‚¿ã‚¤ãƒ æƒ…å ±ã®ãƒªã‚»ãƒƒãƒˆ
            if (useTimeBonus) {
                document.getElementById('time-info').textContent = 'ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ä¸­...';
                startTime = Date.now();
            } else {
                document.getElementById('time-info').textContent = '';
            }

            consecutiveWrong = 0; // é€£ç¶šä¸æ­£è§£å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isGameOver = false; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

            // æ­£è§£ç¢ºèªãƒœã‚¿ãƒ³ã¨å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('show-correct').style.display = 'none';
            document.getElementById('retry-problem').style.display = 'none';
            document.getElementById('share-score').style.display = 'none';

            setupSquares();
        }

        // Blueskyã«å…±æœ‰ã™ã‚‹æ©Ÿèƒ½
        function shareToBluesky() {
            // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã‚’å–å¾—
            const currentScore = score;

            // é›£æ˜“åº¦ã‚’æ—¥æœ¬èªã§å–å¾—
            let difficultyText;
            switch (difficultyLevel) {
                case 'easy':
                    difficultyText = 'ç°¡å˜';
                    break;
                case 'hard':
                    difficultyText = 'é›£ã—ã„';
                    break;
                case 'random3':
                    difficultyText = 'ãƒ©ãƒ³ãƒ€ãƒ 3è‰²';
                    break;
                case 'random6':
                    difficultyText = 'ãƒ©ãƒ³ãƒ€ãƒ 6è‰²';
                    break;
                case 'random9':
                    difficultyText = 'ãƒ©ãƒ³ãƒ€ãƒ 9è‰²';
                    break;
                default:
                    difficultyText = 'æ™®é€š';
            }

            // è‰²è¦šãƒ¢ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªã§å–å¾—
            let colorVisionText;
            switch (colorVisionMode) {
                case 'protanopia':
                    colorVisionText = '1å‹è‰²è¦š(På‹)å‘ã‘';
                    break;
                case 'deuteranopia':
                    colorVisionText = '2å‹è‰²è¦š(Då‹)å‘ã‘';
                    break;
                case 'tritanopia':
                    colorVisionText = '3å‹è‰²è¦š(Tå‹)å‘ã‘';
                    break;
                case 'simulate-protanopia':
                    colorVisionText = '1å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
                    break;
                case 'simulate-deuteranopia':
                    colorVisionText = '2å‹è‰²è¦šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
                    break;
                default:
                    colorVisionText = 'é€šå¸¸';
            }

            // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
            const gameModeText = gameMode === 'normal' ? 'é€šå¸¸ãƒ¢ãƒ¼ãƒ‰' : 'ç„¡é™ãƒ¢ãƒ¼ãƒ‰';

            // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é€£ç¶šæ­£è§£æ•°ã‚‚è¡¨ç¤º
            const streakText = gameMode === 'infinite' ? `é€£ç¶šæ­£è§£æ•°: ${infiniteStreak} ` : '';

            // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—
            const pageUrl = window.location.href;

            // å…±æœ‰ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            const message = `RGBè‰²å½“ã¦ã‚²ãƒ¼ãƒ ã§${currentScore}ç‚¹ã‚’ç²å¾—ã—ã¾ã—ãŸï¼${streakText}(${gameModeText}, é›£æ˜“åº¦: ${difficultyText}, è‰²è¦šãƒ¢ãƒ¼ãƒ‰: ${colorVisionText}) #RGBã‚²ãƒ¼ãƒ  #è‰²å½“ã¦ #çµ¶å¯¾RGBåŠ› ${pageUrl}`;

            // Blueskyã®æŠ•ç¨¿ç”»é¢ã‚’é–‹ãï¼ˆAT Protocolã‚’ä½¿ç”¨ï¼‰
            // æ³¨æ„ï¼šBlueskyã¯æ­£å¼ãªã‚·ã‚§ã‚¢ç”¨URLãŒãªã„ãŸã‚ã€ä»£æ›¿æ‰‹æ®µã¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(message)
                .then(() => {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã€Blueskyã‚’é–‹ã
                    window.open('https://bsky.app', '_blank');

                    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    document.getElementById('message').textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Blueskyã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';
                    document.getElementById('message').style.color = 'blue';
                    document.getElementById('message').className = '';
                })
                .catch(err => {
                    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
                    document.getElementById('message').textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    document.getElementById('message').style.color = 'red';
                    document.getElementById('message').className = '';
                    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                });
        }

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ãƒœã‚¿ãƒ³
        document.getElementById('new-game').addEventListener('click', function() {
            // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: 0`;
            consecutiveCorrect = 0; // é€£ç¶šæ­£è§£å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('combo').textContent = ''; // ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢

            // ç„¡é™ãƒ¢ãƒ¼ãƒ‰ã®é€£ç¶šæ­£è§£æ•°ã‚‚ãƒªã‚»ãƒƒãƒˆ
            infiniteStreak = 0;
            if (gameMode === 'infinite') {
                document.getElementById('infinite-streak').textContent = `é€£ç¶šæ­£è§£æ•°: ${infiniteStreak}`;
            }

            // ã‚¿ã‚¤ãƒ æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (useTimeBonus) {
                document.getElementById('time-info').textContent = 'ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ä¸­...';
                startTime = Date.now();
            } else {
                document.getElementById('time-info').textContent = '';
            }

            resetGame();
        });

        // Blueskyã«å…±æœ‰ãƒœã‚¿ãƒ³
        document.getElementById('share-score').addEventListener('click', shareToBluesky);

        // æ­£è§£ç¢ºèªãƒœã‚¿ãƒ³
        document.getElementById('show-correct').addEventListener('click', showCorrectAnswer);

        // å•é¡Œã‚’ã‚‚ã†ä¸€åº¦è©¦ã™ãƒœã‚¿ãƒ³
        document.getElementById('retry-problem').addEventListener('click', retryProblem);

        // åˆæœŸé›£æ˜“åº¦ã«å¿œã˜ã¦æœ€å¤§ä¸æ­£è§£å›æ•°ã‚’è¨­å®š
        if (difficultyLevel === 'easy' || difficultyLevel === 'random3') {
            maxWrongAttempts = 2; // ç°¡å˜ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ©ãƒ³ãƒ€ãƒ 3è‰²ã¯2å›ã¾ã§
        } else {
            maxWrongAttempts = 3; // ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã¯3å›ã¾ã§
        }

        // åˆæœŸåŒ–
        setupSquares();
    </script>

    <!-- Service Workerç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Workerã®ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚¹ã‚³ãƒ¼ãƒ—: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Workerã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ', error);
                    });
            });
        }
    </script>
</body>
</html>
